# Managing Dependencies in Packages (uv)

This guide explains how to add, update, remove, and rename dependencies for packages inside `packages/` in this monorepo, using `uv`.

Applies to:
- Workspace: `apps/*` and `packages/*` are members
- Root mapping: workspace packages are registered under `[tool.uv.sources]`

Examples below assume macOS with zsh.

---

## Concepts

- Package: a library under `packages/<name>` with its own `pyproject.toml` and code in `src/`.
- App: a runnable service under `apps/<name>`.
- Workspace: the root `pyproject.toml` declares all members so `uv` can resolve them against each other.
- Distribution name vs import name: `[project].name` is the published distribution name (used in dependency lists). The Python import path is defined by your `src/` layout and module/package names; changing one doesn’t necessarily change the other.

---

## Where to declare dependencies

For a package located at `packages/<pkg>/`, dependencies live in:

- `packages/<pkg>/pyproject.toml`
  - Section: `[project].dependencies`

Example:
```toml
[project]
name = "shared"
version = "0.1.0"
requires-python = ">=3.9"
dependencies = [
  # external deps, e.g.
  # "httpx>=0.27",
  # internal workspace deps by distribution name, e.g.
  # "base"
]
```

---

## External dependencies (PyPI)

Run these commands from the package directory, e.g. `cd packages/shared`:

- Add a dependency:
```bash
uv add httpx
```

- Add with a version constraint:
```bash
uv add "httpx>=0.27,<0.28"
```

- Remove a dependency:
```bash
uv remove httpx
```

- Upgrade a dependency to the latest that matches constraints:
```bash
uv add --upgrade httpx
```

- Install/sync after manual edits to `pyproject.toml`:
```bash
uv sync
```

Notes:
- Extras are supported, e.g. `uv add "uvicorn[standard]"`.
- Pin exact versions with `==` if you need reproducibility.

---

## Internal dependencies (workspace packages)

Workspace packages are registered in the root `pyproject.toml` under `[tool.uv.sources]`:

```toml
[tool.uv.workspace]
members = ["apps/*", "packages/*"]

[tool.uv.sources]
base = { workspace = true }
shared = { workspace = true }
api = { workspace = true }
```

To depend on another workspace package from your package, reference the other package’s distribution name (its `[project].name`).

Example: Make `packages/shared` depend on `base`:
```bash
cd packages/shared
uv add base
```

If you create a brand new package, add its `[project].name` to root `[tool.uv.sources]` first, then `uv add <name>` from the consumer package.

Optional (path-based) alternative when not using workspace mapping:
```toml
[project]
dependencies = [
  'your-lib @ { path = "../../packages/your-lib", develop = true }'
]
```

---

## Dev / optional dependencies

If you want optional groups (e.g., dev/test tools) for a package, use `[project.optional-dependencies]`:

```toml
[project.optional-dependencies]
dev = ["pytest>=8", "ruff>=0.6"]
```

Install with extras when working locally:
```bash
uv sync --extra dev
```

Or enable all extras:
```bash
uv sync --all-extras
```

This keeps runtime dependencies small while allowing rich tooling locally.

---

## Renaming a package dependency (distribution name change)

When you rename a workspace package’s distribution name:

1) In the package being renamed: update `packages/<pkg>/pyproject.toml`
```toml
[project]
name = "new-name"
```

2) In the root `pyproject.toml`, update the mapping under `[tool.uv.sources]`:
```toml
[tool.uv.sources]
# remove or replace the old entry
new-name = { workspace = true }
```

3) In all dependents’ `pyproject.toml`, replace the old name with the new one under `[project].dependencies`.

4) Re-sync in each affected project (or from root for all):
```bash
uv sync
```

Note: changing the distribution name doesn’t change Python import paths unless you also rename the modules in `src/`.

---

## Working from the repository root

You can sync all workspace members from the root of the repo:
```bash
uv sync
```

This installs and resolves dependencies for all members declared in `[tool.uv.workspace]`.

---

## CI/reproducibility tips

- Commit the lock files generated by `uv` to keep versions reproducible.
- In CI, use frozen installs to avoid drift:
```bash
uv sync --frozen
```
- Prefer semver ranges for libraries that can float minor versions, and pin for apps or production images when needed.

---

## Troubleshooting

- uv not found: install it per https://docs.astral.sh/uv/ (e.g., `curl -LsSf https://astral.sh/uv/install.sh | sh`).
- Workspace package not resolved: ensure the package’s `[project].name` is listed in root `[tool.uv.sources]` and the package is inside a member path.
- Name mismatch: dependency string must match the producer’s `[project].name` exactly.
- Python version errors: match `requires-python` across packages (repo uses `>=3.9`).
- Extras not installed: pass `--extra <name>` or `--all-extras` when syncing.

---

## Quick examples

Add `httpx` to `packages/shared`:
```bash
cd packages/shared
uv add httpx
uv sync
```

Make `packages/base-api` depend on `shared`:
```bash
cd packages/base-api
uv add shared
uv sync
```

Rename `base` to `base-api`:
- Change `[project].name` in `packages/base-api/pyproject.toml` to `base-api`
- Update root `[tool.uv.sources]`: `base-api = { workspace = true }`
- Update dependents’ dependencies from `"base"` to `"base-api"`
- Run `uv sync`

You’re set! Adjust the steps similarly for any other package under `packages/`.
